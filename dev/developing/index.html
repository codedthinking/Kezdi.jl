<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Contributing · Kezdi.jl</title><meta name="title" content="Contributing · Kezdi.jl"/><meta property="og:title" content="Contributing · Kezdi.jl"/><meta property="twitter:title" content="Contributing · Kezdi.jl"/><meta name="description" content="Documentation for Kezdi.jl."/><meta property="og:description" content="Documentation for Kezdi.jl."/><meta property="twitter:description" content="Documentation for Kezdi.jl."/><meta property="og:url" content="https://codedthinking.github.io/Kezdi.jl/developing/"/><meta property="twitter:url" content="https://codedthinking.github.io/Kezdi.jl/developing/"/><link rel="canonical" href="https://codedthinking.github.io/Kezdi.jl/developing/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="Kezdi.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">Kezdi.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../reference/">Reference</a></li><li class="is-active"><a class="tocitem" href>Contributing</a><ul class="internal"><li><a class="tocitem" href="#Developer-documentation"><span>Developer documentation</span></a></li><li><a class="tocitem" href="#Style-guide"><span>Style guide</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Contributing</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Contributing</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/codedthinking/Kezdi.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/codedthinking/Kezdi.jl/blob/main/docs/src/developing.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><div class="admonition is-warning"><header class="admonition-header">Kezdi.jl is in beta</header><div class="admonition-body"><p><code>Kezdi.jl</code> is currently in beta. We have more than 400 unit tests and a large code coverage. <a href="https://codecov.io/gh/codedthinking/Kezdi.jl"><img src="https://codecov.io/gh/codedthinking/Kezdi.jl/branch/main/graph/badge.svg" alt="Coverage"/></a> The package, however, is not guaranteed to be bug-free. If you encounter any issues, please report them as a <a href="https://github.com/codedthinking/Kezdi.jl/issues/new">GitHub issue</a>.</p><p>If you would like to receive updates on the package, please star the repository on GitHub and sign up for <a href="https://relentless-producer-1210.ck.page/62d7ebb237">email notifications here</a>.</p></div></div><div class="admonition is-warning"><header class="admonition-header">This is the developer documentation</header><div class="admonition-body"><p>You are currently reading the documentation for developers. This explains the internal working of Kezdi.jl. If you do not want to change or contribute to Kezdi.jl functionality, head over to the <a href>end-user documentation</a>.</p></div></div><h2 id="Developer-documentation"><a class="docs-heading-anchor" href="#Developer-documentation">Developer documentation</a><a id="Developer-documentation-1"></a><a class="docs-heading-anchor-permalink" href="#Developer-documentation" title="Permalink"></a></h2><h3 id="How-Kezdi.jl-works:-High-level-overview"><a class="docs-heading-anchor" href="#How-Kezdi.jl-works:-High-level-overview">How Kezdi.jl works: High-level overview</a><a id="How-Kezdi.jl-works:-High-level-overview-1"></a><a class="docs-heading-anchor-permalink" href="#How-Kezdi.jl-works:-High-level-overview" title="Permalink"></a></h3><p>At its core, Kezdi.jl is a <em>transpiler</em>: it takes commands with Stata-like syntax entered by the user and translates them to regular Julia function calls to DataFrames and other modules. Most of the code deals with steps in this transpiling process:</p><ol><li>scanning and parsing Julia expression to be evaluated as Kezdi.jl syntax</li><li>generating Julia code common for all commands, like subsetting dataframe rows whenever <code>@if</code> is used</li><li>generating Julia code specific to the command called</li></ol><p>As an example, let us see how the following Kezdi.jl command becomes Julia code:</p><pre><code class="language-julia hljs">@replace distance = 5 @if distance &lt; 0</code></pre><p>The compiler will try to expand the <code>@replace</code> macro. It will hence call the macro <code>replace</code>, defined in <code>src/macros.jl</code>. The macro definition is almost identical for all Kezdi.jl macros:</p><pre><code class="language-julia hljs">macro replace(exprs...)
    :replace |&gt; parse(exprs) |&gt; rewrite
end</code></pre><p>The function <code>parse</code>, defined in <code>src/parse.jl</code> consumes all the Julia tokens to the right of <code>@replace</code> and returns a <code>Command</code> struct with the command name, arguments, and the expression to be evaluated, including any options or <code>@if</code> clauses. In this case, we get</p><pre><code class="language-julia hljs">Kezdi.Command(:replace, (:(distance = 5),), :(distance &lt; 5), ())</code></pre><p>This <code>Command</code> is then passed onto the <code>rewrite</code> function, defined in <code>src/codegen.jl</code>. This function dispatches on the first argument of the <code>Command</code> struct and first calls the function <code>generate_command</code> (also defined in <code>src/codegen.jl</code>). This function returns a <code>GeneratedCommand</code>. (All structs are defined in <code>src/structs.jl</code>.) The <code>GeneratedCommand</code> struct contains the</p><ol><li>name of the DataFrame with which the command was called</li><li>name of the DataFrame to operate on<ul><li>This will be different from the first if there is an <code>@if</code> clause or a <code>by</code> option</li></ul></li><li>a Julia <code>quote</code> block that will run before the command<ul><li>This usually deals with error checking, subsetting rows and grouping the DataFrame</li></ul></li><li>name of a function to be run after the command has finished</li><li>arguments and</li><li>options as parsed</li></ol><p>This <code>GeneratedCommand</code> is then consumed by the <code>rewrite</code> function which implements the actual functionality of the command. In this case, the function does runtime error checking (like making sure that the column <code>distance</code> exists in the DataFrame), type checking and promotion and the actual replacement of values. The function returns a Julia <code>quote</code> block that will be evaluated by Julia in its next step of compilation (code lowering).</p><p>Removing <code>LineNumberNode</code>s for brevity, the final Julia code will look like this:</p><pre><code class="language-julia hljs">!(&quot;distance&quot; in names(getdf())) &amp;&amp; ArgumentError(&quot;Column \&quot;distance\&quot; does not exist in $(names(getdf()))&quot;) |&gt; throw
begin
    getdf() isa AbstractDataFrame || error(&quot;Kezdi.jl commands can only operate on a global DataFrame set by setdf()&quot;)
    local var&quot;##386&quot; = copy(getdf())
    local var&quot;##387&quot; = view(var&quot;##386&quot;, falses(nrow(var&quot;##386&quot;)) .| Missings.replace((var&quot;##386&quot;).distance .&lt; 5, false), :)
    function var&quot;##389&quot;(x)
        begin
        end
        x
    end
end
eltype_RHS = if 5 isa AbstractVector
        eltype(5)
    else
        typeof(5)
    end
eltype_LHS = eltype(var&quot;##386&quot;[.!(falses(nrow(var&quot;##386&quot;)) .| Missings.replace((var&quot;##386&quot;).distance .&lt; 5, false)), &quot;distance&quot;])
if eltype_RHS != eltype_LHS
    local var&quot;##390&quot; = Vector{promote_type(eltype_LHS, eltype_RHS)}(undef, nrow(var&quot;##386&quot;))
    var&quot;##390&quot;[falses(nrow(var&quot;##386&quot;)) .| Missings.replace((var&quot;##386&quot;).distance .&lt; 5, false)] .= 5
    var&quot;##390&quot;[.!(falses(nrow(var&quot;##386&quot;)) .| Missings.replace((var&quot;##386&quot;).distance .&lt; 5, false))] .= var&quot;##386&quot;[.!(falses(nrow(var&quot;##386&quot;)) .| Missings.replace((var&quot;##386&quot;).distance .&lt; 5, false)), &quot;distance&quot;]
    var&quot;##386&quot;[!, &quot;distance&quot;] = var&quot;##390&quot;
else
    var&quot;##387&quot;[!, &quot;distance&quot;] .= 5
end
(var&quot;##386&quot; |&gt; var&quot;##389&quot;) |&gt; setdf</code></pre><p>Note that macro hygene dictates the use of temporary variables like <code>var&quot;##386&quot;</code> and <code>var&quot;##387&quot;</code> to avoid name clashes with the user&#39;s code. This is a little hard to debug as a developer, but the generated code will typically not be seen by the end user.</p><h2 id="Style-guide"><a class="docs-heading-anchor" href="#Style-guide">Style guide</a><a id="Style-guide-1"></a><a class="docs-heading-anchor-permalink" href="#Style-guide" title="Permalink"></a></h2></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../reference/">« Reference</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Monday 18 November 2024 09:26">Monday 18 November 2024</span>. Using Julia version 1.11.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
